# mask.js - 原生JavaScript敏感数据处理工具

## 概述

mask.js 是一个轻量级的原生JavaScript工具，专门用于处理敏感数据的显示。它提供了两个核心功能：

1. 提取符合特定格式的敏感数据中的掩码内容
2. 为HTML标签提供过滤器语法支持，允许在模板中使用 `{{ data | mask }}` 语法

## 特性

- **纯原生JavaScript**：无依赖，可在任何JavaScript环境中运行
- **自动识别**：自动识别并处理符合 `_mask|algorithm|nonce|encrypt|mac|mask` 格式的数据
- **模板过滤器**：支持在HTML标签中使用过滤器语法
- **跨平台兼容**：支持浏览器、Node.js和AMD模块环境
- **简单易用**：仅需一行代码即可集成

## 文件结构

```
sensitive/
├── mask.js           # 核心工具文件
├── README-js.md      # 原生JavaScript使用文档
├── README-vue.md     # Vue框架使用文档
├── README-react.md   # React框架使用文档
└── README-wx-applet.md # 微信小程序使用文档
```

## API 参考

### mask(data)

**参数：**
- `data` (String): 可能包含敏感数据格式的字符串

**返回值：**
- (String): 如果符合敏感数据格式，则返回mask部分；否则返回原始数据

**功能：**
- 识别并提取敏感数据格式 `_mask|algorithm|nonce|encrypt|mac|mask` 中的掩码内容
- 其中algorithm、nonce、encrypt、mac部分必须符合Base64Url编码格式
- 如果输入不是敏感数据格式，则原样返回

### parseTemplates()

**参数：** 无

**返回值：** 无

**功能：**
- 解析DOM中所有使用过滤器语法的标签
- 将 `{{ data | filter }}` 表达式替换为实际处理结果
- 支持过滤器链，如 `{{ data | filter1 | filter2 }}`

## 使用方法

### 1. 在HTML页面中直接使用

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>mask.js 示例</title>
  <!-- 引入mask.js -->
  <script src="path/to/mask.js"></script>
</head>
<body>
  <div>
    <!-- 使用过滤器语法 -->
    <p>用户名: <text>{{user.name | mask}}</text></p>
    <p>手机号: <text>{{user.phone | mask}}</text></p>
  </div>

  <script>
    // 定义全局变量用于模板中访问
    window.user = {
      name: '_mask|1|a1b2c3|d4e5f6|789abc|张*',
      phone: '_mask|1|a1b2c3|d4e5f6|789abc|138****1234'
    };
    
    // mask.js 会在DOM加载完成后自动解析模板
    // 如果需要手动触发解析，可以调用：
    // window.parseTemplates();
  </script>
</body>
</html>
```

### 2. 直接调用JavaScript函数

```javascript
// 在JavaScript代码中使用
const { mask } = require('./mask.js'); // Node.js环境
// 或直接使用全局变量 mask (浏览器环境)

// 处理敏感数据
const sensitiveData = '_mask|1|a1b2c3|d4e5f6|789abc|138****1234';
const maskedResult = mask(sensitiveData);
console.log(maskedResult); // 输出: 138****1234

// 处理普通数据
const normalData = '普通文本';
console.log(mask(normalData)); // 输出: 普通文本
```

### 3. 在动态内容中使用

```javascript
// 动态创建内容并应用过滤器
function createUserProfile(userData) {
  // 手动处理数据
  const profile = document.createElement('div');
  profile.className = 'user-profile';
  
  profile.innerHTML = `
    <h3>用户信息</h3>
    <p>用户名: <span id="user-name">{{userData.name | mask}}</span></p>
    <p>手机号: <span id="user-phone">{{userData.phone | mask}}</span></p>
  `;
  
  // 添加到页面
  document.body.appendChild(profile);
  
  // 将数据绑定到window对象以便模板访问
  window.userData = userData;
  
  // 手动触发解析
  window.parseTemplates();
  
  return profile;
}

// 使用示例
createUserProfile({
  name: '_mask|1|a1b2c3|d4e5f6|789abc|李*',
  phone: '_mask|1|a1b2c3|d4e5f6|789abc|159****6789'
});

// Node.js环境使用
const { mask } = require('./mask.js');

// 在服务器端使用
function formatUserResponse(user) {
  return {
    ...user,
    name: mask(user.name),
    phone: mask(user.phone),
    email: mask(user.email)
  };
}
```

## 过滤器链支持

mask.js 支持过滤器链，可以连续应用多个过滤器：

```html
<p>处理结果: <text>{{user.data | filter1 | mask | filter2}}</text></p>
```

你可以注册自定义过滤器：

```javascript
// 注册自定义过滤器
window.filters = window.filters || {};
window.filters.toUpperCase = function(str) {
  return String(str).toUpperCase();
};

// 在模板中使用
// <p>大写用户名: <text>{{user.name | mask | toUpperCase}}</text></p>
```
```

## 最佳实践

### 1. 数据预绑定

在DOM加载前，确保需要在模板中使用的数据已经绑定到window对象：

```javascript
// 尽早绑定数据
window.appData = {
  user: {
    name: '_mask|1|a1b2c3|d4e5f6|789abc|王*',
    email: '_mask|1|a1b2c3|d4e5f6|789abc|exa****@example.com'
  }
};
```

### 2. 手动解析

当动态添加内容时，记得调用 `parseTemplates()` 方法：

```javascript
// 动态更新内容后
function updateContent() {
  document.getElementById('content').innerHTML = `
    <p>动态内容: <text>{{dynamicData | mask}}</text></p>
  `;
  
  window.dynamicData = '_mask|1|a1b2c3|d4e5f6|789abc|动态数据内容';
  window.parseTemplates();
}
```

### 3. 错误处理

在使用前验证数据格式，确保程序稳定性：

```javascript
function safeRender(data) {
  try {
    return mask(data);
  } catch (error) {
    console.error('处理敏感数据时出错:', error);
    return data || '';
  }
}
```

## 兼容性说明

- **浏览器支持**：所有现代浏览器 (Chrome, Firefox, Safari, Edge)
- **Node.js**：支持 v8.0 及以上版本
- **模块系统**：支持 CommonJS, AMD 和全局变量

## 错误处理

mask.js 内置了基本的错误处理机制：

1. 非字符串输入会原样返回
2. 格式不匹配时会原样返回
3. 模板解析错误会记录到控制台但不影响程序运行

## 注意事项

1. **全局变量依赖**：模板语法依赖于全局变量，请注意变量命名冲突
2. **性能考虑**：频繁调用 `parseTemplates()` 可能影响性能，建议批量更新后调用
3. **安全考虑**：本工具仅用于前端显示处理，不会进行加密或解密操作
4. **模板语法**：仅支持简单的 `{{ data | filter }}` 语法，不支持复杂表达式

## 版本信息

- **版本: 1.0.0**
- **功能**：原生JavaScript敏感数据处理和H5标签过滤器支持
- **作者**: Generated by AI Assistant
- **日期**: 2024-01-15